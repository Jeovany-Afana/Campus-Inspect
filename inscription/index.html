<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Mise Ã  jour annÃ©e acadÃ©mique</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #ffe0b2, #fff3e0);
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 24px 28px;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(255, 152, 0, 0.1);
    }

    .title {
      font-size: 1.4rem;
      margin-bottom: 4px;
      color: #e65100;
    }

    .subtitle {
      font-size: 0.9rem;
      color: #616161;
      margin-bottom: 16px;
    }

    .info {
      background: #fff8e1;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 0.85rem;
      color: #6d4c41;
      border: 1px solid #ffe082;
      margin-bottom: 18px;
    }

    .info b {
      color: #e65100;
    }

    button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #ff9800, #fb8c00);
      color: white;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      box-shadow: 0 6px 12px rgba(255, 152, 0, 0.35);
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.1s ease;
    }

    button:disabled {
      opacity: 0.6;
      cursor: progress;
      box-shadow: none;
    }

    button:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(255, 152, 0, 0.45);
    }

    button span.spinner {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.4);
      border-top-color: #ffffff;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .status {
      margin-top: 14px;
      font-size: 0.9rem;
      padding: 8px 10px;
      border-radius: 8px;
      display: none;
    }

    .status.ok {
      display: block;
      background: #e8f5e9;
      color: #1b5e20;
      border: 1px solid #c8e6c9;
    }

    .status.error {
      display: block;
      background: #ffebee;
      color: #b71c1c;
      border: 1px solid #ffcdd2;
    }

    .log {
      margin-top: 10px;
      font-size: 0.8rem;
      max-height: 180px;
      overflow-y: auto;
      padding-right: 4px;
      color: #424242;
    }

    .log-entry {
      margin-bottom: 4px;
    }

    .log-entry.ok {
      color: #2e7d32;
    }

    .log-entry.error {
      color: #c62828;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="title">Mise Ã  jour des Ã©tudiants</div>
    <div class="subtitle">Collection <b>users</b> â€“ champ <code>annee_academique_id</code></div>

    <div class="info">
      En cliquant sur ce bouton, tous les documents de la collection <b>users</b> dont
      le champ <code>role == "etudiant"</code> auront leur champ
      <code>annee_academique_id</code> mis Ã  jour pour inclure <b>"2024-2025"</b>
      (sous forme de <b>tableau</b>, sans supprimer les annÃ©es dÃ©jÃ  prÃ©sentes).
    </div>

    <button id="updateButton">
      <span>Mettre Ã  jour tous les Ã©tudiants</span>
    </button>

    <div id="status" class="status"></div>
    <div id="log" class="log"></div>
  </div>

  <script type="module">
    // ðŸ”¥ Imports Firebase modulaire
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      query,
      where,
      doc,
      updateDoc,
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    // ðŸ§© Config Firebase (ta config actuelle)
    const firebaseConfig = {
      apiKey: "AIzaSyDibbuBJ2p88T26P0BAB-o_exunK0GYFdA",
      authDomain: "inspecteur-de-classes.firebaseapp.com",
      projectId: "inspecteur-de-classes",
      storageBucket: "inspecteur-de-classes.appspot.com",
      messagingSenderId: "572661846292",
      appId: "1:572661846292:web:aeb0374db2d414fef9f201",
      measurementId: "G-NVN5GERDV6",
    };

    // ðŸ”§ Initialisation Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const TARGET_YEAR = "2024-2025";

    const btn = document.getElementById("updateButton");
    const statusDiv = document.getElementById("status");
    const logDiv = document.getElementById("log");

    function setStatus(message, type = "ok") {
      statusDiv.textContent = message;
      statusDiv.className = "status " + type;
    }

    function addLog(message, type = "ok") {
      const p = document.createElement("div");
      p.className = "log-entry " + type;
      p.textContent = message;
      logDiv.appendChild(p);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function updateAcademicYearForStudents() {
      btn.disabled = true;
      const originalLabel = btn.innerHTML;
      btn.innerHTML = '<span class="spinner"></span><span>Mise Ã  jour en cours...</span>';
      statusDiv.className = "status";
      statusDiv.style.display = "none";
      logDiv.innerHTML = "";

      try {
        addLog("Chargement des Ã©tudiants (role == 'etudiant')...", "ok");

        const q = query(collection(db, "users"), where("role", "==", "etudiant"));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          setStatus("Aucun utilisateur avec role = 'etudiant' trouvÃ© dans la collection users.", "error");
          addLog("Aucun document trouvÃ©.", "error");
          btn.disabled = false;
          btn.innerHTML = originalLabel;
          return;
        }

        let updatedCount = 0;
        let skippedCount = 0;

        for (const docSnap of snapshot.docs) {
          const data = docSnap.data();
          const userId = docSnap.id;

          let years = data.annee_academique_id;

          // On force en tableau
          if (!Array.isArray(years)) {
            years = [];
          }

          if (!years.includes(TARGET_YEAR)) {
            years.push(TARGET_YEAR);
            try {
              await updateDoc(doc(db, "users", userId), {
                annee_academique_id: years,
              });
              updatedCount++;
              addLog(`âœ… ${userId} mis Ã  jour (annee_academique_id = [${years.join(", ")}])`, "ok");
            } catch (err) {
              addLog(`âŒ Erreur sur ${userId} : ${err.message}`, "error");
            }
          } else {
            skippedCount++;
            addLog(`âžœ ${userId} dÃ©jÃ  contient "${TARGET_YEAR}" (aucun changement)`, "ok");
          }
        }

        setStatus(
          `Mise Ã  jour terminÃ©e : ${updatedCount} Ã©tudiant(s) modifiÃ©(s), ${skippedCount} dÃ©jÃ  Ã  jour.`,
          "ok"
        );
      } catch (error) {
        console.error(error);
        setStatus("Erreur lors de la mise Ã  jour des Ã©tudiants. Voir la console.", "error");
        addLog("Erreur globale : " + error.message, "error");
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalLabel;
      }
    }

    btn.addEventListener("click", () => {
      updateAcademicYearForStudents();
    });
  </script>
</body>
</html>
