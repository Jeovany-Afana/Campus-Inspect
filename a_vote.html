<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ajouter 2025-2026 aux √©tudiants</title>
    <style>
        body { font-family: system-ui, Arial; padding: 24px; max-width: 900px; margin: auto; }
        button { padding: 12px 16px; border: 0; border-radius: 10px; cursor: pointer; font-weight: 700; }
        .primary { background: #2563eb; color: #fff; }
        .primary:disabled { opacity: .6; cursor: not-allowed; }
        pre { background: #0b1220; color: #e5e7eb; padding: 14px; border-radius: 10px; overflow: auto; }
        .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .badge { background: #eef2ff; color: #1e40af; padding: 6px 10px; border-radius: 999px; font-weight: 700; }
    </style>
</head>
<body>
<h1>Maj Firestore ‚Äî √âtudiants</h1>
<p>
    Objectif : ajouter <span class="badge">2025-2026</span> dans <code>annee_academique_id</code>
    pour tous les utilisateurs dont <code>role = "etudiant"</code>, sans supprimer l‚Äôexistant.
</p>

<div class="row">
    <button id="runBtn" class="primary">Ajouter 2025-2026 aux √©tudiants</button>
    <span id="status"></span>
</div>

<h3>Logs</h3>
<pre id="logs"></pre>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import {
        getFirestore,
        collection,
        getDocs,
        query,
        where,
        doc,
        writeBatch,
        arrayUnion,
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    // ‚úÖ Mets ta config Firebase ici
    const firebaseConfig = {
        apiKey: "AIzaSyDibbuBJ2p88T26P0BAB-o_exunK0GYFdA",
        authDomain: "inspecteur-de-classes.firebaseapp.com",
        projectId: "inspecteur-de-classes",
        storageBucket: "inspecteur-de-classes.appspot.com",
        messagingSenderId: "572661846292",
        appId: "1:572661846292:web:aeb0374db2d414fef9f201",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const TARGET_YEAR = "2025-2026";

    const runBtn = document.getElementById("runBtn");
    const logsEl = document.getElementById("logs");
    const statusEl = document.getElementById("status");

    function log(msg) {
        logsEl.textContent += msg + "\n";
        logsEl.scrollTop = logsEl.scrollHeight;
    }

    function setStatus(text) {
        statusEl.textContent = text;
    }

    runBtn.addEventListener("click", async () => {
        runBtn.disabled = true;
        logsEl.textContent = "";
        setStatus("Traitement...");

        try {
            // ‚úÖ Filtrer uniquement les √©tudiants c√¥t√© Firestore
            const q = query(collection(db, "users"), where("role", "==", "etudiant"));
            const snap = await getDocs(q);

            if (snap.empty) {
                log("Aucun √©tudiant trouv√©.");
                setStatus("Termin√© (0).");
                runBtn.disabled = false;
                return;
            }

            log(`√âtudiants trouv√©s : ${snap.size}`);

            // ‚ö†Ô∏è Firestore batch = max 500 √©critures par batch
            let batch = writeBatch(db);
            let ops = 0;

            let updatedCount = 0;

            for (const userDoc of snap.docs) {
                const data = userDoc.data();
                const ref = doc(db, "users", userDoc.id);

                // On utilise arrayUnion => ajoute seulement si absent
                batch.update(ref, {
                    annee_academique_id: arrayUnion(TARGET_YEAR),
                });

                ops++;
                updatedCount++;

                // Commit tous les 450-500 pour √™tre safe
                if (ops >= 450) {
                    await batch.commit();
                    log(`‚úÖ Batch commit (${ops} updates)`);
                    batch = writeBatch(db);
                    ops = 0;
                }
            }

            if (ops > 0) {
                await batch.commit();
                log(`‚úÖ Batch commit final (${ops} updates)`);
            }

            log(`üéâ Mise √† jour termin√©e. Documents concern√©s : ${updatedCount}`);
            setStatus(`Termin√© ‚úÖ (${updatedCount} √©tudiants)`);
        } catch (err) {
            console.error(err);
            log("‚ùå Erreur: " + (err?.message || err));
            setStatus("Erreur ‚ùå (voir logs)");
        } finally {
            runBtn.disabled = false;
        }
    });
</script>
</body>
</html>
